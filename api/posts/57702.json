{"title":"Eureka","slug":"Cloud_Eureka","date":"2022-07-22","updated":"2022-07-22","comments":true,"path":"api/posts/57702.json","excerpt":"<blockquote><p> 关于 EureKa 的知识笔记：Eureka 的服务注册与发现 </p></blockquote>","cover":null,"covers":null,"content":"<blockquote>\n<p>关于 EureKa 的知识笔记：Eureka 的服务注册与发现</p>\n</blockquote>\n<span id=\"more\"></span>\n<h1 id=\"小知识\"><a href=\"# 小知识\" class=\"headerlink\" title=\"小知识\"></a>小知识</h1><blockquote>\n<ul>\n<li>Eureka 不用自己注册自己</li>\n<li>注意启动顺序，服务端必须先启动才能检索到客户端</li>\n<li>集群配置：互相注册，相互守望</li>\n<li>配置 host 之后记得在 cmd 使用 ipconfig /flushdns 刷新一下</li>\n<li>大坑！！！: 配置集群之后，直接点击链接是访问不了的！！多了一层路径！必须要手动输入地址!</li>\n<li>defaultZone 如果有多个 url，不同的 url 通过逗号隔开</li>\n</ul>\n</blockquote>\n<blockquote>\n<h1 id=\"依赖引入\"><a href=\"# 依赖引入\" class=\"headerlink\" title=\"依赖引入\"></a>依赖引入 </h1><h2 id=\"服务注册端 -server\"><a href=\"# 服务注册端 -server\" class=\"headerlink\" title=\"服务注册端 server\"></a> 服务注册端 server</h2></blockquote>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<h2 id=\"客户端 -client\"><a href=\"# 客户端 -client\" class=\"headerlink\" title=\"客户端 client\"></a>客户端 client</h2></blockquote>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<h1 id=\"单机版在 Application-yml 中配置\"><a href=\"# 单机版在 Application-yml 中配置\" class=\"headerlink\" title=\"单机版在 Application.yml 中配置\"></a>单机版在 Application.yml 中配置 </h1><h2 id=\"单机版在 server 端中的 yml 配置\"><a href=\"# 单机版在 server 端中的 yml 配置\" class=\"headerlink\" title=\"单机版在 server 端中的 yml 配置\"></a> 单机版在 server 端中的 yml 配置</h2></blockquote>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">eureka:</span></span><br><span class=\"line\"> <span class=\"attr\">instance:</span></span><br><span class=\"line\">   <span class=\"attr\">hostname:</span> <span class=\"string\">localhost</span>  <span class=\"comment\">#eureka 服务端的实例名字</span></span><br><span class=\"line\"> <span class=\"attr\">client:</span></span><br><span class=\"line\">   <span class=\"attr\">register-with-eureka:</span> <span class=\"literal\">false</span>    <span class=\"comment\"># 表示不向注册中心注册自己</span></span><br><span class=\"line\">   <span class=\"attr\">fetch-registry:</span> <span class=\"literal\">false</span>   <span class=\"comment\"># 表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span></span><br><span class=\"line\">   <span class=\"attr\">service-url:</span></span><br><span class=\"line\">     <span class=\"comment\"># 设置与 eureka server 交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br><span class=\"line\">     <span class=\"attr\">defaultZone:</span> <span class=\"string\">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<blockquote>\n<h2 id=\"单机版在 client 端的 yml 配置\"><a href=\"# 单机版在 client 端的 yml 配置\" class=\"headerlink\" title=\"单机版在 client 端的 yml 配置\"></a>单机版在 client 端的 yml 配置</h2></blockquote>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">eureka:</span></span><br><span class=\"line\">  <span class=\"attr\">client:</span></span><br><span class=\"line\">    <span class=\"comment\"># 表明自己需要注册进 Eureka 中</span></span><br><span class=\"line\">    <span class=\"attr\">register-with-eureka:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"comment\"># 是否从 EurekaServer 抓取已有信息，默认为 true。</span></span><br><span class=\"line\">    <span class=\"comment\"># 单节点无所谓，集群的话必须设置为 true 才能配合 ribbon 使用负载均衡</span></span><br><span class=\"line\">    <span class=\"attr\">fetch-registry:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">service-url:</span></span><br><span class=\"line\">      <span class=\"comment\"># 设置与 eureka server 交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br><span class=\"line\">      <span class=\"comment\"># 单机指向自己</span></span><br><span class=\"line\">      <span class=\"attr\">defaultZone:</span> <span class=\"string\">http://localhost:7001/eureka</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<blockquote>\n<h1 id=\"集群版在 Application-xml 中的配置\"><a href=\"# 集群版在 Application-xml 中的配置\" class=\"headerlink\" title=\"集群版在 Application.xml 中的配置\"></a>集群版在 Application.xml 中的配置 </h1><h2 id=\"在 Client 端的 yml 配置\"><a href=\"# 在 Client 端的 yml 配置\" class=\"headerlink\" title=\"在 Client 端的 yml 配置\"></a> 在 Client 端的 yml 配置</h2><hr>\n<p>最主要的在于 defalutZone 的变化<br>eureka7001.com 是 host 文件配置的主机名</p>\n</blockquote>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">eureka:</span></span><br><span class=\"line\">  <span class=\"attr\">client:</span></span><br><span class=\"line\">    <span class=\"attr\">register-with-eureka:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">fetch-registry:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">service-url:</span></span><br><span class=\"line\">    <span class=\"comment\"># 集群指向其他 eureka</span></span><br><span class=\"line\">      <span class=\"attr\">defaultZone:</span> <span class=\"string\">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<h2 id=\"在 Server 端的 yml 配置\"><a href=\"# 在 Server 端的 yml 配置\" class=\"headerlink\" title=\"在 Server 端的 yml 配置\"></a>在 Server 端的 yml 配置</h2></blockquote>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">eureka:</span></span><br><span class=\"line\">  <span class=\"attr\">instance:</span></span><br><span class=\"line\">    <span class=\"attr\">hostname:</span> <span class=\"string\">eureka7002.com</span>  <span class=\"comment\">#eureka 服务端的实例名字</span></span><br><span class=\"line\">  <span class=\"attr\">client:</span></span><br><span class=\"line\">    <span class=\"attr\">register-with-eureka:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">fetch-registry:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">service-url:</span></span><br><span class=\"line\">    <span class=\"comment\"># 集群指向其他 eureka</span></span><br><span class=\"line\">      <span class=\"attr\">defaultZone:</span> <span class=\"string\">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<h1 id=\"在主运行类中的注解标识\"><a href=\"# 在主运行类中的注解标识\" class=\"headerlink\" title=\"在主运行类中的注解标识\"></a>在主运行类中的注解标识</h1><h2 id=\"Server 端使用的主键\"><a href=\"#Server 端使用的主键\" class=\"headerlink\" title=\"Server 端使用的主键\"></a>Server 端使用的主键</h2></blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@EnableEurekaServer</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<h2 id=\"Client 端使用的注解\"><a href=\"#Client 端使用的注解\" class=\"headerlink\" title=\"Client 端使用的注解\"></a>Client 端使用的注解</h2></blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@EnableEurekaClient</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<h2 id=\"服务发现\"><a href=\"# 服务发现\" class=\"headerlink\" title=\"服务发现\"></a>服务发现 </h2><p> 将服务信息放到到注册中心去 <br> 通过服务发现来活动该服务的信息</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Resource</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> DiscoveryClient discoveryClient;</span><br></pre></td></tr></table></figure>\n\n\n<blockquote>\n<h1 id=\"Instance 配置\"><a href=\"#Instance 配置\" class=\"headerlink\" title=\"Instance 配置\"></a>Instance 配置</h1></blockquote>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">instance:</span></span><br><span class=\"line\">  <span class=\"comment\"># 微服务下实例名称修改</span></span><br><span class=\"line\">  <span class=\"attr\">instance-id:</span> <span class=\"string\">payment8002</span></span><br><span class=\"line\">  <span class=\"comment\"># 显示 IP 地址</span></span><br><span class=\"line\">  <span class=\"attr\">prefer-ip-address:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<h1 id=\"Eureka 的自我保护机制\"><a href=\"#Eureka 的自我保护机制\" class=\"headerlink\" title=\"Eureka 的自我保护机制\"></a>Eureka 的自我保护机制 </h1><p> 自我保护机制: 默认情况下 EurekaClient 定时向 EurekaServer 端发送心跳包 <br> 如果 Eureka 在 server 端在一定时间内 (默认 90 秒) 没有收到 EurekaClient 发送心跳包 , 便会直接从服务注册列表中剔除该服务 <br> 但是在短时间 (90 秒中) 内丢失了大量的服务实例心跳,<br>这时候 EurekaServer 会开启自我保护机制, 不会剔除该服务 (该现象可能出现在网络不通的情况使得 EurekaClient 为出现宕机<br> 此时如果换做别的注册中心如果一定时间内没有收到心跳会将剔除该服务, 这样就出现了严重失误, 因为客户端还能正常发送心跳只是网络延迟问题，而保护机制是为了解决此问题而产生的)</p>\n</blockquote>\n<blockquote>\n<h1 id=\"关闭 Eureka 的自动保护机制\"><a href=\"# 关闭 Eureka 的自动保护机制\" class=\"headerlink\" title=\"关闭 Eureka 的自动保护机制\"></a>关闭 Eureka 的自动保护机制</h1><p>server 端</p>\n</blockquote>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Server 端的 yml 中设置关闭自我保护机制，保证不可用服务被及时踢除</span></span><br><span class=\"line\"><span class=\"attr\">eureka:</span></span><br><span class=\"line\">  <span class=\"attr\">server:</span></span><br><span class=\"line\">     <span class=\"attr\">enable-self-preservation:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">     <span class=\"attr\">eviction-interval-timer-in-ms:</span> <span class=\"number\">2000</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>client 端设置心跳响应时间</p>\n</blockquote>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">eureka:</span></span><br><span class=\"line\">  <span class=\"attr\">instance:</span></span><br><span class=\"line\"><span class=\"comment\">#    Eureka 客户端向服务端发送心跳的时间间隔，单位为秒(默认是 30 秒)</span></span><br><span class=\"line\">   <span class=\"attr\">lease-renewal-interval-in-seconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"comment\">#    Eureka 服务端在收到最后一次心跳后等待时间上限，单位为秒(默认是 90 秒)，超时将剔除服务</span></span><br><span class=\"line\">   <span class=\"attr\">lease-expiration-duration-in-seconds:</span> <span class=\"number\">2</span></span><br></pre></td></tr></table></figure>\n","url":"/posts/57702/","min2read":4,"word4post":996,"prev_post":{"title":"IDEA_Hotkeys","url":"/posts/10025/"},"next_post":{"title":"dependencies","url":"/posts/18669/"},"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"小知识\" href = \"#\"><span class=\"toc-number\">1.</span> <span class=\"toc-text\">小知识</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"依赖引入\" href = \"#\"><span class=\"toc-number\">2.</span> <span class=\"toc-text\">依赖引入 </span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"服务注册端 -server\" href = \"#\"><span class=\"toc-number\">2.1.</span> <span class=\"toc-text\"> 服务注册端 server</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"客户端 -client\" href = \"#\"><span class=\"toc-number\">2.2.</span> <span class=\"toc-text\">客户端 client</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"单机版在 Application-yml 中配置\" href = \"#\"><span class=\"toc-number\">3.</span> <span class=\"toc-text\">单机版在 Application.yml 中配置 </span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"单机版在 server 端中的 yml 配置\" href = \"#\"><span class=\"toc-number\">3.1.</span> <span class=\"toc-text\"> 单机版在 server 端中的 yml 配置</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"单机版在 client 端的 yml 配置\" href = \"#\"><span class=\"toc-number\">3.2.</span> <span class=\"toc-text\">单机版在 client 端的 yml 配置</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"集群版在 Application-xml 中的配置\" href = \"#\"><span class=\"toc-number\">4.</span> <span class=\"toc-text\">集群版在 Application.xml 中的配置 </span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"在 Client 端的 yml 配置\" href = \"#\"><span class=\"toc-number\">4.1.</span> <span class=\"toc-text\"> 在 Client 端的 yml 配置</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"在 Server 端的 yml 配置\" href = \"#\"><span class=\"toc-number\">4.2.</span> <span class=\"toc-text\">在 Server 端的 yml 配置</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"在主运行类中的注解标识\" href = \"#\"><span class=\"toc-number\">5.</span> <span class=\"toc-text\">在主运行类中的注解标识</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"Server 端使用的主键\" href = \"#\"><span class=\"toc-number\">5.1.</span> <span class=\"toc-text\">Server 端使用的主键</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"Client 端使用的注解\" href = \"#\"><span class=\"toc-number\">5.2.</span> <span class=\"toc-text\">Client 端使用的注解</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" data-id=\"服务发现\" href = \"#\"><span class=\"toc-number\">5.3.</span> <span class=\"toc-text\">服务发现 </span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"Instance 配置\" href = \"#\"><span class=\"toc-number\">6.</span> <span class=\"toc-text\">Instance 配置</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"Eureka 的自我保护机制\" href = \"#\"><span class=\"toc-number\">7.</span> <span class=\"toc-text\">Eureka 的自我保护机制 </span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"关闭 Eureka 的自动保护机制\" href = \"#\"><span class=\"toc-number\">8.</span> <span class=\"toc-text\">关闭 Eureka 的自动保护机制</span></a></li></ol>","categories":[{"name":"Service_Registry","path":"api/categories/Service_Registry.json","url":"/categories/Service-Registry/"}],"tags":[{"name":"Eureka","path":"api/tags/Eureka.json","url":"/tags/Eureka/"}]}