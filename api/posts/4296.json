{"title":"GateWay","slug":"Cloud_Gateway","date":"2022-07-25","updated":"2022-08-11","comments":true,"path":"api/posts/4296.json","excerpt":"<blockquote><p> 对服务网关 GateWay 的知识总结 </p></blockquote>","cover":"http://xtzl.wentexl.cn/%E6%9E%B6%E6%9E%84%E5%9B%BE.png","covers":["http://xtzl.wentexl.cn/%E6%9E%B6%E6%9E%84%E5%9B%BE.png","http://xtzl.wentexl.cn/GateWay%E6%96%AD%E8%A8%80.png"],"content":"<blockquote>\n<p> 对服务网关 GateWay 的知识总结 </p>\n</blockquote>\n<span id=\"more\"></span>\n<h1 id=\"核心与注意点\"><a href=\"# 核心与注意点\" class=\"headerlink\" title=\"核心与注意点\"></a> 核心与注意点 </h1><blockquote>\n<ul>\n<li>GateWay 作为网关也需要注册进注册中心 </li>\n<li> 路由、断言、过滤器 </li>\n<li> 网关不能部署在 Tomcat、Jetty 等 Servlet 容器里，只能打成 jar 包执行 </li>\n<li>​依赖于 netty 和 WebFlux </li>\n<li>GateWay 不能加 Web 的起步依赖的 jar 包 </li>\n</ul>\n</blockquote>\n<h1 id=\"架构图\"><a href=\"# 架构图\" class=\"headerlink\" title=\"架构图\"></a> 架构图 </h1><p><img src=\"http://xtzl.wentexl.cn/%E6%9E%B6%E6%9E%84%E5%9B%BE.png\" alt=\"alt\"></p>\n<h1 id=\"依赖导入\"><a href=\"# 依赖导入\" class=\"headerlink\" title=\"依赖导入\"></a> 依赖导入 </h1><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.cloud<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"第一种配置方法：yml 配置\"><a href=\"# 第一种配置方法：yml 配置\" class=\"headerlink\" title=\"第一种配置方法：yml 配置\"></a> 第一种配置方法：yml 配置 </h1><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">9527</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">application:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">cloud-gateway</span></span><br><span class=\"line\">  <span class=\"attr\">cloud:</span></span><br><span class=\"line\">    <span class=\"attr\">gateway:</span></span><br><span class=\"line\">      <span class=\"attr\">discovery:</span></span><br><span class=\"line\">        <span class=\"attr\">locator:</span></span><br><span class=\"line\">          <span class=\"attr\">enabled:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 开启从注册中心动态创建路由的功能，利用微服务名进行路由 </span></span><br><span class=\"line\">      <span class=\"attr\">routes:</span></span><br><span class=\"line\">       <span class=\"comment\">#payment_route #路由的 ID，没有固定规则但要求唯一，建议配合服务名 </span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">payment_routh</span></span><br><span class=\"line\">          <span class=\"comment\">#uri: http://localhost:8001          #匹配后提供服务的路由地址 </span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">lb://cloud-payment-service</span> <span class=\"comment\"># 匹配后提供服务的路由地址 </span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/payment/get/**</span>         <span class=\"comment\"># 断言，路径相匹配的进行路由 </span></span><br><span class=\"line\">         <span class=\"comment\">#payment_route    #路由的 ID，没有固定规则但要求唯一，建议配合服务名 </span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">id:</span> <span class=\"string\">payment_routh2</span></span><br><span class=\"line\">         <span class=\"comment\"># uri: http://localhost:8001          #匹配后提供服务的路由地址 </span></span><br><span class=\"line\">          <span class=\"attr\">uri:</span> <span class=\"string\">lb://cloud-payment-service</span> <span class=\"comment\"># 匹配后提供服务的路由地址 </span></span><br><span class=\"line\">          <span class=\"attr\">predicates:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">Path=/payment/lb/**</span>         <span class=\"comment\"># 必须是真正提供服务的方法 </span></span><br><span class=\"line\">         <span class=\"comment\">#- After=2020-05-13T21:55:10.016+08:00[Asia/Shanghai]</span></span><br><span class=\"line\">         <span class=\"comment\"># -Before</span></span><br><span class=\"line\">         <span class=\"comment\"># -Between=2020-05-13T21:55:10.016+08:00[Asia/Shanghai],2021-05-13T21:55:10.016+08:00[Asia/Shanghai]</span></span><br><span class=\"line\">         <span class=\"comment\">#- Cookie=username,milo</span></span><br><span class=\"line\">         <span class=\"comment\">#- Header=X-Request-Id, \\d+  # 请求头要有 X-Request-Id 属性并且值为整数的正则表达式 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">eureka:</span></span><br><span class=\"line\">  <span class=\"attr\">instance:</span></span><br><span class=\"line\">    <span class=\"attr\">hostname:</span> <span class=\"string\">cloud-gateway-service</span></span><br><span class=\"line\">  <span class=\"attr\">client:</span> <span class=\"comment\"># 服务提供者 provider 注册进 eureka 服务列表内 </span></span><br><span class=\"line\">    <span class=\"attr\">service-url:</span></span><br><span class=\"line\">      <span class=\"attr\">register-with-eureka:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">fetch-registry:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">defaultZone:</span> <span class=\"string\">http://eureka7001.com:7001/eureka</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"第二种配置方法：Config 配置\"><a href=\"# 第二种配置方法：Config 配置\" class=\"headerlink\" title=\"第二种配置方法：Config 配置\"></a> 第二种配置方法：Config 配置 </h1><blockquote>\n<p> 当访问 /guonei 的时候，自动转发到 <a href=\"http://news.baidu.com/guonei\">http://news.baidu.com/guonei</a></p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"> <span class=\"keyword\">public</span> RouteLocator <span class=\"title function_\">customRouteLocator</span><span class=\"params\">(RouteLocatorBuilder routeLocatorBuilder)</span></span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">     RouteLocatorBuilder.<span class=\"type\">Builder</span> <span class=\"variable\">routes</span> <span class=\"operator\">=</span> routeLocatorBuilder.routes();</span><br><span class=\"line\">     routes.route(<span class=\"string\">&quot;path_route_atguigu&quot;</span>,</span><br><span class=\"line\">             r -&gt; r.path(<span class=\"string\">&quot;/guonei&quot;</span>)</span><br><span class=\"line\">                     .uri(<span class=\"string\">&quot;http://news.baidu.com/guonei&quot;</span>)).build();</span><br><span class=\"line\">     <span class=\"keyword\">return</span> routes.build();</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"yml 配置的时候，断言选项\"><a href=\"#yml 配置的时候，断言选项\" class=\"headerlink\" title=\"yml 配置的时候，断言选项\"></a>yml 配置的时候，断言选项 </h1><p><img src=\"http://xtzl.wentexl.cn/GateWay%E6%96%AD%E8%A8%80.png\" alt=\"断言\"></p>\n<h1 id=\"curl 开发\"><a href=\"#curl 开发\" class=\"headerlink\" title=\"curl 开发\"></a>curl 开发 </h1><blockquote>\n<ul>\n<li> 判断是否携带名为 X-Request-Id 的请求头，且其值必须是一个大于 0 的整数  </li>\n<li>-Header=X-Request-Id, \\d+   </li>\n<li>curl <a href=\"http://localhost:9527/payment/lb\">http://localhost:9527/payment/lb</a> -H “X-Request-Id:123”</li>\n</ul>\n<hr>\n<ul>\n<li> 判断请求是否携带 cookie 名为 username，值为 milo</li>\n<li> -Cookie = username,milo</li>\n<li>curl <a href=\"http://localhost:9527/payment/lb\">http://localhost:9527/payment/lb</a> –cookie “username=123”</li>\n</ul>\n</blockquote>\n<h1 id=\"自定义过滤器\"><a href=\"# 自定义过滤器\" class=\"headerlink\" title=\"自定义过滤器\"></a> 自定义过滤器 </h1><blockquote>\n<p> 主要是要实现 GlobalFilter,Ordered 这两个接口 </p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MyLogGateWayFilter</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">GlobalFilter</span>,Ordered</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Mono&lt;Void&gt; <span class=\"title function_\">filter</span><span class=\"params\">(ServerWebExchange exchange, GatewayFilterChain chain)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;***********come in MyLogGateWayFilter:  &quot;</span>+<span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>());</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">uname</span> <span class=\"operator\">=</span> exchange.getRequest().getQueryParams().getFirst(<span class=\"string\">&quot;uname&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(uname == <span class=\"literal\">null</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;******* 用户名为 null，非法用户，o(╥﹏╥)o&quot;</span>);</span><br><span class=\"line\">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> exchange.getResponse().setComplete();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> chain.filter(exchange);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> <span class=\"title function_\">getOrder</span><span class=\"params\">()</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","url":"/posts/4296/","min2read":3,"word4post":662,"prev_post":{"title":"Cloud_Config","url":"/posts/8012/"},"next_post":{"title":"JavaUtils","url":"/posts/13372/"},"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"核心与注意点\" href = \"#\"><span class=\"toc-number\">1.</span> <span class=\"toc-text\"> 核心与注意点 </span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"架构图\" href = \"#\"><span class=\"toc-number\">2.</span> <span class=\"toc-text\"> 架构图 </span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"依赖导入\" href = \"#\"><span class=\"toc-number\">3.</span> <span class=\"toc-text\"> 依赖导入 </span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"第一种配置方法：yml 配置\" href = \"#\"><span class=\"toc-number\">4.</span> <span class=\"toc-text\"> 第一种配置方法：yml 配置 </span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"第二种配置方法：Config 配置\" href = \"#\"><span class=\"toc-number\">5.</span> <span class=\"toc-text\"> 第二种配置方法：Config 配置 </span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"yml 配置的时候，断言选项\" href = \"#\"><span class=\"toc-number\">6.</span> <span class=\"toc-text\">yml 配置的时候，断言选项 </span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"curl 开发\" href = \"#\"><span class=\"toc-number\">7.</span> <span class=\"toc-text\">curl 开发 </span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" data-id=\"自定义过滤器\" href = \"#\"><span class=\"toc-number\">8.</span> <span class=\"toc-text\"> 自定义过滤器 </span></a></li></ol>","categories":[{"name":"Service_Gateway","path":"api/categories/Service_Gateway.json","url":"/categories/Service-Gateway/"}],"tags":[{"name":"GateWay","path":"api/tags/GateWay.json","url":"/tags/GateWay/"}]}